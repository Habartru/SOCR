# 🏗️ Архитектура проекта SuperOCR

## 📋 Описание проекта

SuperOCR - это система массовой обработки документов с использованием Surya OCR и интеграцией с LLM моделями для анализа содержимого. Проект предназначен для автоматизированной обработки российских деловых документов с высокой точностью распознавания и анализа.

## 🚀 Запуск проекта

**ЕДИНСТВЕННЫЙ СПОСОБ ЗАПУСКА:**
```bash
surya_env\Scripts\python.exe gui_run.py
```

## 📊 Общая схема архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                        ПОЛЬЗОВАТЕЛЬ                             │
└─────────────────────┬───────────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────────┐
│                   GUI ИНТЕРФЕЙС                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Tkinter GUI   │  │  Streamlit Web  │  │   Console CLI   │  │
│  │  (Настольный)   │  │   (Веб-браузер) │  │   (Командная)   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────────┐
│                 УПРАВЛЯЮЩИЙ СЛОЙ                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              Batch Processing Manager                       │ │
│  │  • Управление очередью файлов                              │ │
│  │  • Мониторинг прогресса                                    │ │
│  │  • Обработка ошибок                                        │ │
│  │  • Логирование                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────────┐
│                   SURYA OCR ЯДРО                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Detection     │  │  Recognition    │  │    Layout       │  │
│  │   Predictor     │  │   Predictor     │  │   Analysis      │  │
│  │                 │  │                 │  │                 │  │
│  │ • Обнаружение   │  │ • Распознавание │  │ • Анализ        │  │
│  │   текста        │  │   текста        │  │   структуры     │  │
│  │ • Детекция      │  │ • OCR в 90+     │  │ • Таблицы       │  │
│  │   областей      │  │   языках        │  │ • Заголовки     │  │
│  │ • Bounding      │  │ • Математика    │  │ • Изображения   │  │
│  │   boxes         │  │ • LaTeX         │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────────┐
│                  МОДЕЛИ И ДАННЫЕ                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  PyTorch Models │  │   Model Cache   │  │  Configuration  │  │
│  │                 │  │                 │  │                 │  │
│  │ • Detection     │  │ • Локальное     │  │ • settings.py   │  │
│  │   модель        │  │   кеширование   │  │ • .env файлы    │  │
│  │ • Recognition   │  │ • Автозагрузка  │  │ • Параметры     │  │
│  │   модель        │  │   с S3          │  │   батчей        │  │
│  │ • Layout модель │  │ • Версионность  │  │ • GPU/CPU       │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────────┐
│                 LLM ИНТЕГРАЦИЯ                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   LM Studio     │  │     Ollama      │  │   OpenAI API    │  │
│  │                 │  │                 │  │                 │  │
│  │ • Локальная     │  │ • Локальная     │  │ • Облачная      │  │
│  │   модель        │  │   модель        │  │   модель        │  │
│  │ • REST API      │  │ • REST API      │  │ • REST API      │  │
│  │ • Классификация │  │ • Анализ        │  │ • Анализ        │  │
│  │   документов    │  │   текста        │  │   текста        │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────────┐
│                 ХРАНЕНИЕ ДАННЫХ                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   CSV Files     │  │   JSON Files    │  │   Log Files     │  │
│  │                 │  │                 │  │                 │  │
│  │ • ocr_result.   │  │ • Результаты    │  │ • Логи          │  │
│  │   csv           │  │   анализа LLM   │  │   обработки     │  │
│  │ • Структуриро-  │  │ • Метаданные    │  │ • Ошибки        │  │
│  │   ванные данные │  │   документов    │  │ • Статистика    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Поток обработки данных

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   PDF/IMG   │───▶│   ЗАГРУЗКА  │───▶│ ПРЕДОБРА-   │───▶│  ДЕТЕКЦИЯ   │
│   ФАЙЛЫ     │    │   ФАЙЛОВ    │    │   БОТКА     │    │   ТЕКСТА    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                           │                     │
                   ┌─────────────┐    ┌─────▼─────┐         ┌─────▼─────┐
                   │ СОХРАНЕНИЕ  │◀───│  АНАЛИЗ   │◀────────│    OCR    │
                   │ РЕЗУЛЬТАТОВ │    │    LLM    │         │ РАСПОЗНА- │
                   └─────────────┘    └───────────┘         │   ВАНИЕ   │
                                                            └───────────┘
```

## 📁 Актуальная структура проекта SuperOCR

### 🟢 Основные файлы (активно используются)
```
SuperOCR/
├── 🔴 gui_run.py                      # ОСНОВНОЙ ФАЙЛ ЗАПУСКА
├── 📁 surya_env/                     # Виртуальное окружение Python
├── 📁 surya/                        # Оригинальная библиотека Surya OCR
├── 📄 PROJECT_ARCHITECTURE.md        # Документация проекта
├── 📄 local.env                      # Настройки окружения
└── 📄 ocr_result.csv                 # Результаты обработки
```

### 🔴 ЛИШНИЕ файлы (подлежат удалению)
```
├── ❌ run_gui.bat                      # Устаревший bat-файл
├── ❌ start_batch_gui.bat              # Неиспользуемый bat-файл
├── ❌ start_simple_gui.bat             # Неиспользуемый bat-файл
├── ❌ surya_batch_gui.py               # Устаревший GUI
├── ❌ test_surya_ocr.py                # Тестовый скрипт (не нужен)
├── ❌ check_gpu.py                     # Тест GPU (не нужен)
├── ❌ gpu_check.py                     # Дубликат теста GPU
├── ❌ logLLM.txt                       # Старые логи
├── ❌ surya_log_*.txt                  # Старые логи
└── ❌ запуск.txt                     # Ненужные заметки
```

## ⚙️ Основной функционал SuperOCR

### 🎯 Возможности системы

1. **📄 Массовая обработка PDF документов**
   - Параллельная обработка множества файлов
   - Поддержка многостраничных документов
   - Автоматическое создание результирующих файлов

2. **🔍 Высокоточное OCR распознавание**
   - Использование Surya OCR для максимальной точности
   - Поддержка русского языка и кириллицы
   - Сохранение координат текста (bounding boxes)
   - Определение уровня уверенности распознавания

3. **🤖 Интеграция с LLM для анализа**
   - Поддержка LM Studio (локальные модели)
   - Поддержка OpenAI API (GPT-4, GPT-3.5 и др.)
   - Автоматический анализ содержимого документов
   - Извлечение структурированных данных

4. **⚡ Оптимизация производительности**
   - Многопоточная обработка OCR
   - Параллельные LLM воркеры
   - Система автоповтора при ошибках
   - Умное усечение данных для экономии токенов

5. **📊 Мониторинг и статистика**
   - Реальное время обработки
   - Статистика OCR и LLM отдельно
   - Общая статистика (среднее время на документ)
   - Скорость обработки (документов в минуту)

6. **🛑 Управление процессами**
   - Кнопка остановки обработки
   - Автоматическое завершение при закрытии GUI
   - Принудительное завершение зависших процессов

## 🧩 Компоненты системы

### 1. **GUI Слой (gui_run.py)**

```python
# Основные компоненты GUI
┌─────────────────────────────────────┐
│           GUI Components            │
├─────────────────────────────────────┤
│ • Folder Selection                  │
│ • Progress Indicators               │
│ • Log Display                       │
│ • Settings Configuration            │
│ • File Management                   │
└─────────────────────────────────────┘
```

**Функции:**
- Выбор папок с PDF файлами
- Настройка параметров обработки
- Мониторинг прогресса
- Отображение логов
- Управление результатами

### 2. **Surya OCR Ядро**

```python
# Архитектура Surya OCR
┌─────────────────────────────────────┐
│         Surya OCR Core              │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────┐ ┌─────────────┐    │
│  │ Detection   │ │ Recognition │    │
│  │ Predictor   │ │ Predictor   │    │
│  └─────────────┘ └─────────────┘    │
│         │               │           │
│  ┌─────────────┐ ┌─────────────┐    │
│  │   Layout    │ │   Common    │    │
│  │  Analysis   │ │  Utilities  │    │
│  └─────────────┘ └─────────────┘    │
└─────────────────────────────────────┘
```

**Возможности:**
- Детекция текстовых областей
- OCR в 90+ языках
- Анализ макета документа
- Распознавание таблиц
- Поддержка математических формул

### 3. **LLM Интеграция**

```python
# LLM Integration Layer
┌─────────────────────────────────────┐
│        LLM Integration              │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────┐ ┌─────────────┐    │
│  │ LM Studio   │ │   Ollama    │    │
│  │   Local     │ │   Local     │    │
│  └─────────────┘ └─────────────┘    │
│         │               │           │
│  ┌─────────────┐ ┌─────────────┐    │
│  │  OpenAI     │ │   Custom    │    │
│  │   Cloud     │ │    APIs     │    │
│  └─────────────┘ └─────────────┘    │
└─────────────────────────────────────┘
```

**Задачи LLM:**
- Классификация документов (Акт, Счёт, Счет-фактура, Договор)
- Извлечение структурированных данных
- Анализ содержимого
- Валидация результатов

### 4. **Система хранения**

```python
# Data Storage System
┌─────────────────────────────────────┐
│         Data Storage                │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────┐ ┌─────────────┐    │
│  │ CSV Files   │ │ JSON Files  │    │
│  │ (OCR Data)  │ │ (LLM Data)  │    │
│  └─────────────┘ └─────────────┘    │
│         │               │           │
│  ┌─────────────┐ ┌─────────────┐    │
│  │ Log Files   │ │ Cache Data  │    │
│  │ (Process)   │ │ (Models)    │    │
│  └─────────────┘ └─────────────┘    │
└─────────────────────────────────────┘
```

## ⚙️ Конфигурация и настройки

### Основные параметры

```python
# settings.py - Ключевые настройки
TORCH_DEVICE = "cuda"              # GPU/CPU
IMAGE_DPI = 96                     # Разрешение для детекции
IMAGE_DPI_HIGHRES = 192           # Разрешение для OCR
DETECTOR_BATCH_SIZE = 32          # Размер батча детекции
RECOGNITION_BATCH_SIZE = 256      # Размер батча распознавания
```

### Переменные окружения

```bash
# .env файл
TORCH_DEVICE=cuda
LOGLEVEL=INFO
MODEL_CACHE_DIR=/path/to/models
DATA_DIR=/path/to/data
RESULT_DIR=/path/to/results
```

## 🔄 Алгоритм обработки

### Пошаговый процесс

```
1. 📁 ЗАГРУЗКА ФАЙЛОВ
   ├── Сканирование папки PDF
   ├── Валидация файлов
   └── Создание очереди обработки

2. 🔍 OCR ОБРАБОТКА
   ├── Загрузка изображений из PDF
   ├── Детекция текстовых областей
   ├── Распознавание текста
   └── Объединение страниц

3. 💾 СОХРАНЕНИЕ OCR
   ├── Формирование JSON структуры
   ├── Запись в CSV файл
   └── Логирование результатов

4. 🤖 LLM АНАЛИЗ
   ├── Отправка текста в LLM
   ├── Классификация документа
   ├── Извлечение данных
   └── Валидация результата

5. 📄 СОХРАНЕНИЕ РЕЗУЛЬТАТОВ
   ├── Создание JSON файла
   ├── Именование по оригиналу
   └── Обновление статистики
```

## 📊 Форматы данных

### CSV структура (ocr_result.csv)

```csv
filename,recognition_date,ocr_json,ocr_text
document1.pdf,2023-02-17,"{""pages"":2,""text_lines"":[...]}","Полный текст документа..."
document2.pdf,2023-02-17,"{""pages"":1,""text_lines"":[...]}","Полный текст документа..."
```

### JSON структура (результат LLM)

```json
{
  "Название файла": "document1.pdf",
  "Тип документа": "Счет-фактура",
  "Номер документа": "СФ-001",
  "Дата документа": "17.02.2023",
  "Наименование заказчика": "ООО Компания",
  "Наименование исполнителя": "ИП Иванов",
  "ИНН заказчика": "1234567890",
  "ИНН исполнителя": "0987654321",
  "КПП заказчика": "123456789",
  "КПП исполнителя": "",
  "Адрес заказчика": "г. Москва, ул. Ленина, д.1",
  "Адрес исполнителя": "г. СПб, ул. Невский, д.2"
}
```

## 🚀 Масштабируемость

### Горизонтальное масштабирование

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Worker 1  │    │   Worker 2  │    │   Worker 3  │
│   (GPU 1)   │    │   (GPU 2)   │    │   (CPU)     │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                  ┌─────────────┐
                  │ Load Balancer│
                  │   (Nginx)    │
                  └─────────────┘
```

### Вертикальное масштабирование

- **CPU**: Многопоточная обработка
- **GPU**: Увеличение размера батчей
- **RAM**: Кеширование моделей
- **Storage**: SSD для быстрого доступа

## 🔧 Мониторинг и отладка

### Ключевые метрики

```python
# Метрики производительности
┌─────────────────────────────────────┐
│         Performance Metrics         │
├─────────────────────────────────────┤
│ • Files/second processing rate      │
│ • GPU/CPU utilization              │
│ • Memory usage                     │
│ • Model loading time               │
│ • OCR accuracy rate                │
│ • LLM response time                │
│ • Error rate                       │
└─────────────────────────────────────┘
```

### Логирование

```python
# Структура логов
[2023-02-17 10:30:15] INFO: Начало обработки файла document1.pdf
[2023-02-17 10:30:16] DEBUG: Загружено 2 страницы
[2023-02-17 10:30:18] INFO: OCR завершен, найдено 45 строк текста
[2023-02-17 10:30:20] INFO: LLM анализ завершен, тип: Счет-фактура
[2023-02-17 10:30:21] INFO: Файл обработан успешно
```

---

**🎯 Эта архитектура обеспечивает:**
- ✅ Модульность и расширяемость
- ✅ Высокую производительность
- ✅ Надежность и отказоустойчивость
- ✅ Простоту развертывания и обслуживания
- ✅ Масштабируемость под любые нагрузки

## 🔧 Техническая информация

### 💻 Системные требования
- **ОП**: Windows 10/11
- **Python**: 3.8+ (в виртуальном окружении surya_env)
- **GPU**: Рекомендуется NVIDIA GPU с CUDA 24+GB
- **ОПЗУ**: Минимум 8GB, рекомендуется 16GB+

### 📦 Основные зависимости
- **surya-ocr**: Основная библиотека OCR
- **torch**: PyTorch для нейронных сетей
- **tkinter**: GUI интерфейс
- **requests**: HTTP клиент для LLM API
- **multiprocessing**: Параллельная обработка

---

## 🎆 Заключение

SuperOCR - мощная система для автоматизированной обработки документов.

✅ **Простота**: Одна команда для запуска  
✅ **Точность**: Современные OCR и LLM технологии  
✅ **Масштаб**: Параллельная обработка сотен документов  
✅ **Гибкость**: Локальные и облачные LLM  

**🚀 Для запуска:** `surya_env\Scripts\python.exe gui_run.py`
